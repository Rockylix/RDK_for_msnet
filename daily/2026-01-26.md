# 2026-01-26 工作日志 (汇总)

## 📋 项目：MSNet立体视觉深度估计

### 时间跨度
2026-01-11 ~ 2026-01-26 (共16天开发周期)

### 摘要
实现了基于RDK开发板BPU的MSNet立体视觉深度估计模型推理。解决了NFS文件共享、模型加载错误、量化校准数据冲突等关键技术问题,最终成功实现板载实时推理,推理延迟36.93ms。

### 详细技术路径

#### 阶段1: 开发环境配置 (1.11)
**目标**: 建立Windows ↔ ARM开发板双向文件共享

- **NFS服务器配置** (开发板侧):
  - 安装`nfs-kernel-server`
  - 配置共享目录`/home/root/workspace`
  - 开放端口: 2049, 111, 1098

- **Remote-SSH配置**:
  - 配置`~/.ssh/config`实现快速连接
  - VS Code Remote-SSH扩展实时编辑板载文件

- **Windows NFS客户端**:
  - 使用haneWIN NFS Server共享本地目录
  - 开发板挂载: `mount -t nfs -o nolock <server_ip>:/msnet <path>`

**Git**: `6e21eedc`, `21a42286`

#### 阶段2: 模型加载问题排查 (1.13) 🔴
**问题**: BPU_loadModel返回错误码-6000002

**排查过程**:
1. 初步怀疑模型过大 (错误模型33.75MB vs 正常模型90MB)
2. 检查Docker环境,发现原始模型应为304MB
3. **根因**: NFS传输过程中中断,导致文件不完整

**解决方案**:
- ✅ 确保文件传输完整性
- ✅ 降低模型分辨率 640×352→384×192

**性能对比**:
| 模型分辨率 | 文件大小 | 加载时间 |
|-----------|---------|---------|
| 684×384 | 304MB | 21.04s |
| 384×192 | - | 6.59s |

**Git**: `c41edb5f`, `01a45571`

#### 阶段3: 内存管理问题 (1.14) 🔴
**问题**: 扩展Swap导致内存占满

**影响**:
- NTP服务崩溃 → 系统时间错误 → Makefile误检测
- 编译失败,无法进行代码编辑

**Git**: `ae519223`

#### 阶段4: 推理结果异常 (1.20 ~ 1.26) ⚡
**现象**: 输入不同图像,输出结果相同(中间蓝,周围红的无意义噪点)

**排查过程**:
1. ✅ 验证ONNX模型正常
2. ✅ 确认BPU工作且利用率高
3. ✅ 验证内存读写正常
4. **定位三重致命冲突** 🎯

**三重致命冲突分析**:

##### 冲突1: 数值量程灾难 (最严重)
- **脚本逻辑**: `log_np / 255.0` → 缩放至[0,1]
- **Config配置**: `mean_value: 123.675` + `data_mean_and_scale`
- **后果**: 输入值 = ([0~1] - 123.675) × 0.017 ≈ -2.1
- **结果**: 信号淹没在死区,网络无法提取纹理

##### 冲突2: 内存排布冲突
- **脚本逻辑**: `transpose(2,0,1)` → CHW排布
- **Config配置**: `input_layout_rt: 'NHWC'`
- **后果**: 量化工具按NHWC解析CHW数据 → 三色重叠

##### 冲突3: 颜色通道冲突
- **脚本逻辑**: `convert('RGB')`
- **Config配置**: `input_type_rt: 'bgr'`
- **后果**: RGB/BGR通道顺序错位

**解决方案**:
1. ✅ 取消校准数据的`/255`归一化
2. ✅ 确保校准数据为uint8格式(非float)
3. ✅ 开启`preproccess_on: True`由模型内部处理
4. ✅ 统一使用BGR格式
5. ✅ 排除letterbox影响,仅使用cut方法

**验证结果**:
- 使用官方模型DStereoV2.6_int8.bin → ✅ 推理成功
- 使用自定义msnet模型(684×384) → ✅ 推理成功

**Git**: `e5a47985` (最终版本)

### 参数记录

#### 推理性能 (官方模型 640×352)
| 阶段 | 耗时 |
|------|------|
| 加载模型 | 262.11 ms |
| GetModelInfo | 0.48 ms |
| 预处理 | 97.04 ms |
| **推理** | **36.93 ms** |
| 后处理 | 63.57 ms |
| **总计** | ~460 ms |

#### 模型规格对比
| 模型 | 分辨率 | 文件大小 | 加载时间 |
|------|--------|---------|---------|
| 官方 | 640×352 | - | 262ms |
| 自定义1 | 684×384 | 304MB | 21.04s |
| 自定义2 | 384×192 | - | 6.59s |

### 关键经验总结 💡

1. **NFS文件传输陷阱**: 
   - 传输大文件(>100MB)必须等待完成,否则生成不完整文件
   - 建议: 传输后校验MD5或文件大小

2. **量化校准数据黄金法则**:
   - 校准数据格式必须与config配置严格一致
   - 数据类型: uint8 (禁止float)
   - 内存排布: 与`input_layout_rt`一致
   - 颜色空间: 与`input_type_rt`一致
   - 归一化: 交给模型内部处理(`preproccess_on: True`)

3. **Swap内存扩展风险**:
   - 过度扩展会导致系统服务崩溃(NTP, systemd)
   - 建议: 优化代码内存占用,而非盲目扩展Swap

### 遗留问题

1. **MSNet自定义模型推理质量**: 虽然能跑通,但效果待验证
2. **模型加载时间优化**: 384×192模型6.5s仍较慢

### Git 提交记录
- `1f1f98a8` - modules (初始日志)
- `6e21eedc`, `21a42286` - NFS配置
- `c41edb5f`, `01a45571`, `ae519223` - 模型加载问题
- `e5a47985` - 量化校准问题最终解决
