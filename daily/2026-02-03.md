# 2026-02-03 工作日志

## 📋 项目：MIPI双目视觉实时深度估计

### 摘要
实现了从MIPI双目摄像头到视差图的完整流程。通过双线程采集优化、曝光白平衡同步尝试,将系统FPS从4提升至8(无SSH转发)。

### 详细技术路径

#### 1. 基础流程打通 ✅
**实现**: MIPI摄像头 → YUV采集 → BPU推理 → 视差图生成 → SSH显示

**性能测试**:
- 开启SSH转发显示视差图: FPS = 4
- 关闭SSH转发: FPS = 8

**结论**: 输入图像采集不占用太多资源,瓶颈在SSH转发

**Git**: commit包含`mipi_msnet/cpp/main.cpp`

#### 2. 双线程时间戳同步 ⚡
**目标**: 解决双目图像不同步导致的视差图边缘破碎问题

**原始代码**:
```cpp
sp_vio_get_frame(_camera1, (char*)sys_mem.virAddr, ...);
sp_vio_get_frame(_camera2, (char*)sys_mem.virAddr+_infer_size, ...);
```

**优化方案**:
- 使用`std::thread`并行获取两路图像
- 记录时间戳,计算帧间时间差
- 若时间差>5ms,重试(最多5次)

**结果**: 
- ❌ 边缘破碎感并无明显改善
- **结论**: 软件时间戳对齐不是主要问题,需要硬件级AE/AWB同步

#### 3. 曝光与白平衡同步尝试 🔄
**问题**: Camera1明显比Camera2亮,色温不一致

**分析**:
- RDK的hbn框架占用摄像头设备
- 无法直接使用`v4l2-ctl`命令设置参数
- 需要在hbn框架内部实现AE/AWB锁定

**待实现方案**:
1. 锁定曝光参数: 手动设置相同曝光时间和增益
2. 色温锁定: 使用固定AWB模式(如"日光"模式)

**状态**: 未完成 (文档截止)

#### 4. 未完成功能
- ❌ 双目标定与图像校正 (需要内参/外参矩阵)

### 参数记录

| 指标 | 数值 |
|------|------|
| SSH转发FPS | 4 |
| 无转发FPS | 8 |
| 时间戳同步阈值 | 5ms |
| 最大重试次数 | 5次 |

### 遗留问题

1. **硬件级AE/AWB同步未实现**: 
   - 需要研究hbn框架的传感器控制API
   - 目标: 实现两路摄像头参数锁定

2. **双目标定缺失**:
   - 需要标定板采集数据
   - 计算内参/外参矩阵
   - 实现图像校正算法

3. **双线程优化效果有限**:
   - 软件时间戳对齐无明显改善
   - 需要硬件触发同步或主从模式

### Git 提交记录
- `9d730316` - modules (包含mipi_msnet完整代码)
